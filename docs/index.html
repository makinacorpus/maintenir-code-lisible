<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

        <title>Maintenir un code lisible</title>
        <link rel="stylesheet" href="./css/reveal.css">
        <link rel="stylesheet" href="./_assets/theme-reveal/makina.css" id="theme">
        <link rel="stylesheet" href="./css/highlight/zenburn.css">
        <link rel="stylesheet" href="./css/print/paper.css" type="text/css" media="print">
          <link rel="stylesheet" href="./_assets/theme-reveal/makina.css">


    </head>
    <body>

        <div class="reveal">
            <div class="slides"><section  data-markdown><script type="text/template">

<!-- .slide: class="title logo" data-background="#b5b42c" -->

# Maintenir un code lisible

### Sébastien Corbin
</script></section><section  data-markdown><script type="text/template">
<!-- .slide: class="programme bg-lion-left" -->

# Préparez-vous

Attention, danger, risque de :

- hémorragie rétinienne 
- hystérie soudaine
- malaise vagal
- nausée

Les premiers rangs risquent d'être arrosés par les derniers

<aside class="notes"><p>Avant de savoir qu&#39;est ce qu&#39;un code lisible il faut se rappeler ce qu&#39;est un code illisible</p>
</aside></script></section><section  data-markdown><script type="text/template">
<!-- .slide: class="title" -->

## Imaginez... un monde sans code style

```
var lol, HAhaHA_I_M_notCONSisTANT =function(     
){return lol;;;;;;;;;;;
                            ;;;;;}; lol=
"Coucou"; alert(HAHAHA_I_M_CONSTANT(
)[ '0' ])
```


```
function zoubida(lavabo)


{
	if(confirm           (lavabo)) for (;;) return true; else {
	  return false
}}
```

<aside class="notes"><p>Bon alors là j&#39;ai pris un language bizarre qui permet de faire du caca</p>
</aside></script></section><section  data-markdown><script type="text/template">
Connaissez-vous l'indentation inversée ?

```
    for(int i = 0; i < 10; i++)
        {
myFunc();
        }
    if(something)
        {
// do A
        }
    else
        {
// do B
    }
```

Oui oui, ça existe 
https://stackoverflow.com/q/218123
https://softwareengineering.stackexchange.com/q/1338
</script></section><section  data-markdown><script type="text/template">
## Et avec python ?

* Syntaxe claire
* Pas d'accolades
* Indentation obligatoire
* Moins de parenthèses
* Pas de bloc anonymes
* Peu de mots-clés

Mais python peut aussi faire de mauvaises syntaxes

```
if ((((bar == None)))): bar = 2
```
```
bar = 3; print(bar)
```

**Défi :** créez/trouvez un obduscateur en Python !

<aside class="notes"><p>Les parenthèses peuvent être illimitées, les points virgules acceptés,
mais beaucoup de concepts sont fermés (exemple des lambda)</p>
</aside></script></section><section  data-markdown><script type="text/template">
<!-- .slide: class="title bg-python" -->

# Une chance de coder sous Python
</script></section><section  data-markdown><script type="text/template">
## Tableau récapitulatif des *coding standards*

| Langage |	Statut| 	Nom |	Commentaires|
|---------|--------|-------|------------|
| PHP|Officiel |PHP-FIG / PSR |Récent, d'autres standards sont apparus avant|
|Javascript|	Communautaire	|ESLint	|C'est le bordel, mais eslint est le plus utilisé|
|Typescript|	Communautaire|		Google a pondu gts||
|Ruby|	Communautaire		|||
|Java|	Communautaire	|	||
|Go|	Officiel|	gofmt|	Voir Effective Go|
|Rust|	Officiel|	rustfmt|	|
|C#	|Officiel		|||
|Python|	Officiel|	PEP8	||
</script></section><section  data-markdown><script type="text/template">
## Introduction à la PEP8

- indentation de 4 espaces
- ligne de 79 caractères
- imports sur plusieurs lignes
- utf-8 par défaut
- snake_case pour variables et fonctions/méthodes
- CamelCase pour classes

Ensuite chaque framework/bibliothèque/projet a son propre coding standard.
</script></section><section  data-markdown><script type="text/template">
<!-- .slide: class="title" data-background="#b5b42c" -->

# Un outil de prédilection :
# le *linter*

<aside class="notes"><ul>
<li>Logical Lint<ul>
<li>Code errors</li>
<li>Code with potentially unintended results</li>
<li>Dangerous code patterns</li>
</ul>
</li>
<li>Stylistic Lint<ul>
<li>Code not conforming to defined conventions</li>
</ul>
</li>
</ul>
</aside></script></section><section  data-markdown><script type="text/template">
Les **outils de base** pour vérifier la compatibilité PEP8 :

* **pylint** : vérificateur d'erreurs de syntaxe
* **pyflakes** : vérificateur d'erreurs de syntaxe
* **autoflake** : formatteur automatique basé sur `pyflakes`
* **pycodestyle** : vérificateur de style (anciennement pep8)
* **autopep8** : formatteur automatique basé sur `pycodestyle`
* **yapf** : formatteur automatique
* **mypy** : vérificateur de typage statique
* **pychecker** : † projet mort †
* **pep8ify** : † projet mort †
* **pyntch** : † projet mort †

http://meta.pycqa.org

<aside class="notes"><p>On pourrait penser que tous ces linters se tirent la bourre
mais ils sont regroupés sous un même groupe de travail
nommé PyCQA (pour Python Code Quality Authority)</p>
</aside></script></section><section  data-markdown><script type="text/template">
<!-- .slide: class="title" data-background="#b5b42c url(theme-reveal/images/bg-lenin.jpg) no-repeat -60% bottom" -->

# Aller plus loin

<aside class="notes"><p>Malgré une PEP8 relativement complète, elle reste laxe sur certains point
il reste donc des petites interrogations que tout le monde se pose</p>
</aside></script></section><section  data-markdown><script type="text/template">
## Nombre de caractères d'une ligne (en vrai)

Certains sont nazis avec 70 caractères, d'autres plus laxes 88 caractères car on est plus sur écran DOS.

Sur les docstring, c'est parfois 72, parfois plus...

<aside class="notes"><p>Limite héritée des écrans touts petits, toujours en vigeur 
car il est plus facile de scanner un code sur une courte colonne 
qu’en faisant des aller-retours constant</p>
<p>Imaginez un journal ecrit sans colonnes</p>
</aside></script></section><section  data-markdown><script type="text/template">
## Wrapping (retour à la ligne)

Des arguments/paramètres

```python
my_super_long_method_name(super_long_argument1, super_long_argument2, super_long_argument3)
```
```python
my_super_long_method_name(super_long_argument1, super_long_argument2, 
                          super_long_argument3)
```
```python
my_super_long_method_name(
    super_long_argument1, super_long_argument2, super_long_argument3
)
```
```python
my_super_long_method_name(
    super_long_argument1, 
    super_long_argument2, 
    super_long_argument3
)
```

<aside class="notes"><p>Plusieurs écoles, choisissez la votre, mais avec la dernière vous pouvez 
vous retrouvez avec des fichiers énormes en terme de lignes</p>
</aside></script></section><section  data-markdown><script type="text/template">
D'une callchain

```python
result = MyLongClassName.my_long_method_name(arg1).my_chained_call(arg4, arg5).my_chained_call2()
```

```python
result = MyLongClassName.my_long_method_name(arg1)\
                        .my_chained_call1(arg4, arg5)\
                        .my_chained_call2()
```

```python
result = MyLongClassName.my_long_method_name(
    arg1
).my_chained_call1(
    arg4, arg5
).my_chained_call2()
```

```python
result = (
    MyLongClassName.my_long_method_name(arg1)
    .my_chained_call1(arg4, arg5)
    .my_chained_call2()
)
```

<aside class="notes"><p>Surtout, restez consistents</p>
</aside></script></section><section  data-markdown><script type="text/template">
Des imports

```python
from mon_package import ma_methode_1, ma_methode_2, ma_methode_3, ma_methode_4, ma_methode_5
```

```python
from mon_package import ma_methode_1, ma_methode_2, ma_methode_3, ma_methode_4,\
                        ma_methode_5
```
```python
from mon_package import (ma_methode_1, ma_methode_2, ma_methode_3, ma_methode_4,
                         ma_methode_5)
```
```python
from mon_package import (
    ma_methode_1, ma_methode_2, ma_methode_3, ma_methode_4, ma_methode_5
)
```
```python
from mon_package import (
    ma_methode_1, 
    ma_methode_2, 
    ma_methode_3, 
    ma_methode_4, 
    ma_methode_5,
)
```
et ça continue avec les listes, les dictionnaires, etc...
</script></section><section  data-markdown><script type="text/template">
## Virgules en fin de ligne

```python
def ma_methode_au_nom_super_long(
    argument1, argument2=None, argument3=None, argument4=None, argument5=None,
    argument6=None, argument7=None, argument8=None, arg9=None, *args, **kwargs
):
```
Doit-on la retirer pour éviter de dépasser les 79 caractères ?


## Apostrophes

Double ou simple quote ? Forcé ou non ?


## Formattage de chaînes

```python
"Bonjour %s, bienvenue chez %s" % ("la vie", "les bisounours")
```
```python
"Bonjour {}, bienvenue chez {}".format('Jean', 'nous')
```
```python
"Bonjour {0}, bienvenue chez {1}".format('Kévin', 'McDonald')
```

<aside class="notes"><p>bon là en l&#39;occurence il n&#39;est censé rien y avoir puisque c&#39;est <code>kwargs</code></p>
<p>Pour le formattage, certains n&#39;accepte plus l&#39;ancienne notation et d&#39;autre force le nommage des placeholders</p>
</aside></script></section><section  data-markdown><script type="text/template">
## Complexité cyclomatique

```python
for i in ma_liste:
    if i < 10:
        try:
            while true:
                answer = ask("why ???")
                if answer = "idontknow"
                    raise DontKnowEception
            except DontKnowEceptiona as e:
                for i in range(3):
                    print("ha")
```

## Maintenabilité

Indice allant de 0 à 100 avec :

* 85+ : maintenabilité bonne
* 65-85 : maintenabilité moyenne
* < 65 : maintenabilité difficile

## Nombre de ligne de code par module

<aside class="notes"><p>vérifier que tout connait le principe de complexité cyclomatique
Ce sont des métrique poussées et parfois peu représentatrices</p>
</aside></script></section><section  data-markdown><script type="text/template">
Encore des outils :

* **radon**/**xenon** : métriques de Halstead
* **isort** : gère l'ordre, le regroupement et le style des imports de manière fine
* **McCabe** : analyse de complexité
* **pylama** : combinaison de `pycodestyle`, `pydocstyle`, `pyflakes`, `mccabe`, `pylint`, `radon`, `gjslint`
* **flake8** : combinaison de `PyFlakes`, `pycodestyle` et `mccabe`
* **black** : formatteur nazi

<aside class="notes"><p>S&#39;arrêter sur isort
Préciser que pylama et flake8 se repose sur les épaule de géants
Pylama un peu plus complexe à configurer
Black est récent, très rapide, peu d&#39;options donc on le lance et on oublie</p>
</aside></script></section><section  data-markdown><script type="text/template">
## Tox

Sert à automatiser les tests, pratique car son fichier de config `tox.ini` est lu par *flake8* et *isort* notamment

```ini
[tox]
skipsdist = true
envlist =
    flake8
    isort

[testenv]
deps = -rdev-requirements.txt

[testenv:flake8]
deps = flake8
commands = flake8 .

[testenv:isort]
deps =
  -rdev-requirements.txt
  isort>=4.2.13
commands = isort --check-only -e

[flake8]
max-complexity = 8
exclude = .tox,__pycache__,*/migrations/*
ignore = F403,F405

[isort]
combine_as_imports = true
multi_line_output = 5
include_trailing_comma = true
skip = migrations,.tox
not_skip = __init__.py
known_django = django
known_first_party = accounts, common, messaging
sections = FUTURE,STDLIB,DJANGO,THIRDPARTY,FIRSTPARTY,LOCALFOLDER
```
</script></section><section  data-markdown><script type="text/template">
## Et le bon vieux **grep** ?!?

```python
import pdb; pdb.set_trace()
import ipdb; ipdb.set_trace()
print("Je passe ici")
```
```javascript
console.log("toto");
alert("lol");
```

Qui c'est qu'à pas fini son merge ?!?

```
Si vous avez des questions :
<<<<<<< HEAD
c'est pas maintenant.
=======
c'est à la fin du talk.
>>>>>>> branch-a
```

<aside class="notes"><p>Que celui ou celle qui n&#39;a jamais oublié un pdb en prod crie kamoulox maintenant</p>
</aside></script></section><section  data-markdown><script type="text/template">
<!-- .slide: class="title bg-rocks"-->

# A quel moment vérifier ?
</script></section><section  data-markdown><script type="text/template">
## Pendant l'écriture

Configurer son IDE : 
    
* Pycharm autoformatte où peut lancer un formatteur avec un raccourci

    * <kbd>Ctrl</kbd>+<kbd>Alt</kbd>+<kbd>L</kbd> sous Linux/Windows
    * <kbd>Cmd</kbd>+<kbd>Opt</kbd>+<kbd>L</kbd> sous Max OS

* Lancer le linter régulièrement en ligne de commande
</script></section><section  data-markdown><script type="text/template">
## Avant de commiter

* Hook Git de pre-commit hook maison

```bash
# à mettre dans votre-projet/.git/hooks/pre-commit et à rendre executable
#!/bin/bash

source ~/.virtualenvs/votre-projet/bin/activate

echo "Checking for syntax"
if ! flake8 || ! isort -e --check-only
then
    echo ""
    echo "Correct the errors above"
    exit 1
fi
```

Un exemple en python https://gist.github.com/streeter/1376856
</script></section><section  data-markdown><script type="text/template">
## Avant de commiter

Fichier de configuration partagé avec [pre-commit](https://pre-commit.com/)

* `pip install pre-commit` ou `brew install pre-commit`

```yaml
# .pre-commit-config.yaml
-   repo: git://github.com/pre-commit/pre-commit-hooks
    sha: v0.9.1
    hooks:
    -   id: trailing-whitespace
    -   id: check-ast
    -   id: check-docstring-first
    -   id: check-merge-conflict
    -   id: debug-statements
    -   id: end-of-file-fixer
    -   id: flake8
-   repo: git://github.com/RobinRamael/pre-commit-isort.git
    hooks:
    -   id: isort
```

* `pre-commit install`

Possibilité d'ajouter ses propres hooks, tout ça, en python
</script></section><section  data-markdown><script type="text/template">
## Avec une Continuous Integration

* Travis CI

```yaml
dist: trusty
language: python
python:
  - "3.6"
install:
  - pip install -r dev-requirements.txt
  - pip install flake8 isort
script:
  - flake8 .
  - isort -e --check-only
```

* GitlabCI

```yaml
image: python

before_script:
  - pip install -r dev-requirements.txt
tests:
  script:
    - flake8 .
    - isort -e --check-only
```
</script></section><section  data-markdown><script type="text/template">
<!-- .slide: class="title alternate" -->

# Des questions ?

https://makinacorpus.github.io/maintenir-code-lisible/

</script></section></div>
        </div>

        <script src="./lib/js/head.min.js"></script>
        <script src="./js/reveal.js"></script>

        <script>
            function extend() {
              var target = {};
              for (var i = 0; i < arguments.length; i++) {
                var source = arguments[i];
                for (var key in source) {
                  if (source.hasOwnProperty(key)) {
                    target[key] = source[key];
                  }
                }
              }
              return target;
            }

            // Optional libraries used to extend on reveal.js
            var deps = [
              { src: './lib/js/classList.js', condition: function() { return !document.body.classList; } },
              { src: './plugin/markdown/marked.js', condition: function() { return !!document.querySelector('[data-markdown]'); } },
              { src: './plugin/markdown/markdown.js', condition: function() { return !!document.querySelector('[data-markdown]'); } },
              { src: './plugin/highlight/highlight.js', async: true, callback: function() { hljs.initHighlightingOnLoad(); } },
              { src: './plugin/zoom-js/zoom.js', async: true },
              { src: './plugin/notes/notes.js', async: true },
              { src: './plugin/math/math.js', async: true }
            ];

            // default options to init reveal.js
            var defaultOptions = {
              controls: true,
              progress: true,
              history: true,
              center: true,
              transition: 'default', // none/fade/slide/convex/concave/zoom
              dependencies: deps
            };

            // options from URL query string
            var queryOptions = Reveal.getQueryHash() || {};

            var options = {"transition":"slide"};
            options = extend(defaultOptions, options, queryOptions);
        </script>


        <script>
          Reveal.initialize(options);
        </script>
    </body>
</html>
